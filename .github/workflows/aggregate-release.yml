name: Aggregate GitHub Releases

on:
  push:
    tags:
      - 'v*'  # Matches tags like v1.2.0, v2.0.1, etc.

jobs:
  aggregate:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.NS_PAT }}

    steps:
      - name: Checkout public changelog repo
        uses: actions/checkout@v4

      - name: Determine tag
        id: tag
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TAG="${{ github.event.inputs.tag }}"
          else
            TAG="${GITHUB_REF##*/}"
          fi

          echo "ðŸ“¦ Using tag: $TAG"
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Prepare
        run: |
          echo "# Release Notes for ${{ steps.tag.outputs.tag }}" > CHANGELOG.md

      - name: Fetch release notes and append to changelog
        run: |
          INPUT_TAG="${{ steps.tag.outputs.tag }}"
          REPOS=("lightingcontrol/DeathStarWindow-CentroBackOffice" \
                "lightingcontrol/Lcd.DeathstarEngine" \
                "lightingcontrol/Centro-mobile-app")

          for REPO in "${REPOS[@]}"; do
            echo "### $REPO" >> CHANGELOG.md

            # Try the input tag as-is
            RELEASE=$(curl -s -H "Authorization: token ${GH_TOKEN}" \
              "https://api.github.com/repos/$REPO/releases/tags/$INPUT_TAG")

            MESSAGE=$(echo "$RELEASE" | jq -r '.message // empty')

            # If the tag is not found, try removing leading 'v'
            if [[ "$MESSAGE" == "Not Found" ]]; then
              ALT_TAG="${INPUT_TAG#v}"
              echo "âž• Trying fallback tag '$ALT_TAG' for $REPO"

              RELEASE=$(curl -s -H "Authorization: token ${GH_TOKEN}" \
                "https://api.github.com/repos/$REPO/releases/tags/$ALT_TAG")
            fi

            # Extract body or fallback
            BODY=$(echo "$RELEASE" | jq -r '.body // "âš ï¸ No release notes found."')
            echo "$BODY" >> CHANGELOG.md
            echo -e "\n" >> CHANGELOG.md
          done



      - name: Commit and push changelog
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"

          git fetch origin main
          git checkout main
          git pull origin main

          git add CHANGELOG.md
          git commit -m "Add aggregated changelog for ${{ steps.tag.outputs.tag }}" || echo "No changes to commit"
          git push origin main
